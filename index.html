<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½è³€è‡ªé§•æ—…ç¨‹å…¨åŠŸèƒ½App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // è¨­å®š Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', // Emerald-500
                        'secondary': '#3b82f6', // Blue-500
                        'background': '#f3f4f6', // Gray-100
                        'highlight': '#f59e0b', // Amber-500 for alerts
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button {
            transition: all 0.3s ease;
            position: relative;
        }
        .tab-button.active {
            color: #10b981; /* primary color */
            font-weight: 600;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background-color: #10b981;
            border-radius: 9999px;
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom alert/confirm modal styling */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 90%;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* æ¨™ç±¤æ¨£å¼ */
        .tag-must-eat { background-color: #fcd34d; color: #92400e; padding: 2px 8px; border-radius: 9999px; font-weight: 600; margin-right: 4px; }
        .tag-must-buy { background-color: #f9a8d4; color: #831843; padding: 2px 8px; border-radius: 9999px; font-weight: 600; margin-right: 4px; }
        .tag-important { background-color: #93c5fd; color: #1e40af; padding: 2px 8px; border-radius: 9999px; font-weight: 600; margin-right: 4px; }
    </style>
</head>
<body class="antialiased">

    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <header class="sticky top-0 bg-white shadow-md z-10">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-bold text-gray-800">ä½è³€è‡ªé§•App</h1>
                <div class="flex space-x-4">
                    <button id="tab-itinerary" class="tab-button active" onclick="switchTab('itinerary')">è¡Œç¨‹è¦åŠƒ</button>
                    <button id="tab-tools" class="tab-button" onclick="switchTab('tools')">æ—…ç¨‹è³‡è¨Šèˆ‡å·¥å…·</button>
                </div>
            </div>
        </div>
        <div id="loading-indicator" class="hidden absolute inset-x-0 bottom-0 h-1 bg-secondary animate-pulse"></div>
    </header>
    
    <!-- User ID é¡¯ç¤º (ç”¨æ–¼èª¿è©¦å’Œå¤šç”¨æˆ¶è­˜åˆ¥) -->
    <div class="text-xs text-center p-1 bg-gray-200 text-gray-500">
        <span id="user-id-display">è¼‰å…¥ä¸­... è«‹ç­‰å¾… Firebase èªè­‰å®Œæˆ</span>
    </div>

    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">

        <!-- è¡Œç¨‹è¦åŠƒ Tab -->
        <div id="itinerary-content" class="tab-content min-h-[calc(100vh-6rem)]">
            <div id="itinerary-list" class="space-y-8">
                <!-- è¡Œç¨‹å¡ç‰‡å°‡ç”± JavaScript æ¸²æŸ“ -->
                <div class="text-center text-gray-500 py-10" id="initial-loading-message">
                    æ­£åœ¨åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...
                </div>
            </div>
        </div>

        <!-- æ—…ç¨‹è³‡è¨Šèˆ‡å·¥å…· Tab -->
        <div id="tools-content" class="tab-content min-h-[calc(100vh-6rem)] hidden">
            <div class="grid grid-cols-1 gap-6">

                <!-- æ—…ç¨‹é‡è¦è³‡è¨Š -->
                <div class="bg-white p-5 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-primary mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        é‡è¦æ—…ç¨‹è³‡è¨Š
                    </h2>
                    <div class="space-y-3 text-sm text-gray-700">
                        <h3 class="font-bold text-secondary border-b pb-1 mb-2">âœˆï¸ èˆªç­è³‡è¨Š</h3>
                        <p><span class="font-semibold">å»ç¨‹ï¼š</span>IT246 æ¡ƒåœ’ (TPE) 07:10 â†’ ä½è³€ (HSG) 10:25</p>
                        <p><span class="font-semibold">å›ç¨‹ï¼š</span>IT247 ä½è³€ (HSG) 15:25 â†’ æ¡ƒåœ’ (TPE)</p>
                        
                        <h3 class="font-bold text-secondary border-b pb-1 mb-2 pt-3">ğŸ¨ ä½å®¿è³‡è¨Š</h3>
                        <p><span class="font-semibold">é£¯åº—ï¼š</span>æ±æ©«INNä½è³€ç«™å‰</p>
                        <p><span class="font-semibold">åœ°å€ï¼š</span>ä½è³€çœŒä½è³€å¸‚é§…å‰ä¸­å¤®1-10-36</p>
                        <p><span class="font-semibold">å‚™è¨»ï¼š</span>å…¨ç¨‹ä¸æ›é£¯åº—</p>

                        <h3 class="font-bold text-secondary border-b pb-1 mb-2 pt-3">ğŸ“ ç·Šæ€¥è¯çµ¡é›»è©±</h3>
                        <p><span class="font-semibold">è­¦å¯Ÿï¼š</span>110</p>
                        <p><span class="font-semibold">æ•‘è­·è»Š/ç«è­¦ï¼š</span>119</p>
                        <p><span class="font-semibold">å°ç£é§ç¦å²¡è¾¦äº‹è™•ï¼š</span>+81-92-734-2810</p>
                    </div>
                </div>

                <!-- è¨˜å¸³å·¥å…· -->
                <div class="bg-white p-5 rounded-xl card-shadow">
                    <h2 class="text-xl font-semibold text-primary mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        æ—…è²»è¨˜å¸³ (æ—¥å¹£ Â¥)
                    </h2>
                    
                    <div class="flex justify-between items-center mb-4 p-3 bg-primary bg-opacity-10 rounded-lg">
                        <p class="text-sm font-semibold text-primary">ç¸½æ”¯å‡º (å³æ™‚æ›´æ–°)</p>
                        <p id="total-expense" class="text-2xl font-extrabold text-red-600">Â¥ 0</p>
                    </div>

                    <div class="flex space-x-3 mb-4">
                        <input type="text" id="expense-desc" placeholder="è²»ç”¨èªªæ˜ (e.g. æ™šé¤)" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary">
                        <input type="number" id="expense-amount" placeholder="é‡‘é¡" class="w-24 p-2 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary text-right">
                        <button onclick="addExpense()" class="bg-primary text-white p-2 rounded-lg hover:bg-emerald-600 transition duration-150 flex-shrink-0 font-medium">
                            æ–°å¢
                        </button>
                    </div>

                    <div id="expense-list" class="space-y-2">
                        <p class="text-center text-gray-500 py-4" id="expense-loading">è¼‰å…¥æ”¯å‡ºä¸­...</p>
                        <!-- æ”¯å‡ºåˆ—è¡¨å°‡ç”± Firestore æˆ– LocalStorage å³æ™‚æ¸²æŸ“ -->
                    </div>
                </div>

            </div>
        </div>
    </main>
    
    <!-- æ¨¡æ…‹æ¡†å®¹å™¨ -->
    <div id="modal-container"></div>
    
    <!-- JavaScript é‚è¼¯ -->
    <script type="module">
        // --- å…¨åŸŸè®Šæ•¸åˆå§‹åŒ–èˆ‡ Firebase å®¹éŒ¯è™•ç† ---
        
        let expenses = [];
        let useLocalStorage = false;
        const LOCAL_STORAGE_KEY = 'saga_expenses_v1';
        
        const initialLoadingMessage = document.getElementById('initial-loading-message');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            // --- Canvas ç’°å¢ƒå…§é‹è¡Œ (å•Ÿç”¨è³‡æ–™åº«) ---
            import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            setLogLevel('debug');

            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${window.userId}`;
                    startApp(); // èªè­‰å®Œæˆï¼Œå•Ÿå‹• App
                } else {
                    // åŸ·è¡Œç™»å…¥æµç¨‹
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch(e) {
                         console.error("Firebase Auth Error:", e);
                         userIdDisplay.textContent = `èªè­‰å¤±æ•—: ${e.message}`;
                         startApp(); // èªè­‰å¤±æ•—ï¼Œä»å•Ÿå‹• App (ä½†è¨˜å¸³å¯èƒ½ç„¡æ•ˆ)
                    }
                }
            });

        } else {
            // --- GitHub Pages/å¤–éƒ¨ç’°å¢ƒé‹è¡Œ (ç¦ç”¨è³‡æ–™åº«ï¼Œåˆ‡æ› LocalStorage) ---
            window.db = null;
            window.auth = null;
            window.userId = 'external_user';
            useLocalStorage = true; // å•Ÿç”¨ LocalStorage æ——æ¨™
            
            window.addEventListener('load', () => {
                 userIdDisplay.textContent = `User ID: (å¤–éƒ¨ç’°å¢ƒ / è¨˜å¸³åŠŸèƒ½ä½¿ç”¨æœ¬åœ°å„²å­˜)`;
                 startApp(); // ç€è¦½å™¨è¼‰å…¥å®Œæˆï¼Œç«‹å³å•Ÿå‹• App
            });
        }
        
        // --- è¡Œç¨‹æ ¸å¿ƒæ•¸æ“š (æœ€çµ‚ä¿®æ­£ç‰ˆ) ---
        const ITINERARY_DATA = [
            {
                day: 1, date: '12/14ï¼ˆæ—¥ï¼‰', city: 'ä½è³€å¸‚', theme: 'ä½è³€æŠµé” â†’ å‰é‡ãƒ¶é‡Œéºè·¡ â†’ BOOKOFF',
                details: [
                    { type: 'flight', time: '10:25', activity: 'æŠµé”ä½è³€æ©Ÿå ´ (HSG) - IT246 æ¡ƒåœ’ â†’ ä½è³€' },
                    { type: 'transport', time: '10:45', activity: 'æ­ä¹˜ä½è³€æ©Ÿå ´å·´å£« â†’ ä½è³€ç«™ (ä¸‹è»Šå¾Œæ­¥è¡Œ 3 åˆ†é˜ â†’ æ±æ©«INNä½è³€ç«™å‰)' },
                    { type: 'meal', time: '11:45-12:15', activity: 'åˆé¤ (ä½è³€ç«™å‘¨é‚Šç°¡å–®åƒ): å»ºè­°ç«™å‰é£Ÿå ‚ã€å‰é‡å®¶ç­‰å¿«é€Ÿé¸é …ã€‚' },
                    { type: 'attraction', time: '12:30-15:00', activity: 'å‰é‡ãƒ¶é‡Œæ­·å²å…¬åœ’ (å½Œç”Ÿæ™‚ä»£éºè·¡)', location: 'å‰é‡ãƒ¶é‡Œæ­´å²å…¬åœ’' },
                    { type: 'shopping', time: '15:30-17:30', activity: 'BOOKOFF æ™‚é–“ (è¦–ç²¾ç¥é¸ 1â€“2 é–“): å»ºè­°å…ˆå»ä½è³€é«˜æœ¨ç€¨åº—ï¼Œè‹¥åªé¸ä¸€é–“å¯é¸ PLUS æ——è‰¦åº—ã€‚', location: 'BOOKOFF ä½è³€é«˜æœ¨ç€¬åº—' },
                    { type: 'meal', time: '18:30', activity: 'æ™šé¤ï¼šç‡’è‚‰å…‰å·åœ’ (æ°£æ°›å¥½ï¼Œè£œå……èƒ½é‡) æˆ–å…¶ä»–ä¸‰é¸ä¸€é¸é …ã€‚', location: 'ç„¼è‚‰å…‰å·åœ’ ä½è³€é§…å‰åº—' },
                    { type: 'hotel', time: '20:00', activity: 'å›é£¯åº—ä¼‘æ¯ (æ˜å¤©é–‹å§‹è‡ªé§•è¡Œç¨‹)' },
                ]
            },
            {
                day: 2, date: '12/15ï¼ˆä¸€ï¼‰', city: 'å”æ´¥å¸‚', theme: 'è‡ªé§•ãƒ»å‘¼å­æœå¸‚ â†’ å”æ´¥åŸ â†’ é¡å±±å±•æœ›å°',
                details: [
                    { type: 'transport', time: '08:00', activity: 'ğŸš— é£¯åº—å‡ºç™¼ â†’ å‘¼å­æœå¸‚ (è»Šç¨‹ç´„ 60 åˆ†, å°èˆªï¼šå‘¼å­æœå¸‚é€šã‚Š)', location: 'å‘¼å­æœå¸‚é€šã‚Š' },
                    { type: 'attraction', time: '09:00-10:00', activity: 'ğŸ¦‘ å‘¼å­æœå¸‚æ•£ç­– (ç”Ÿçƒè³Šåˆºèº«ã€çƒè³Šæ¼¢å ¡ã€çƒè³Šç‡’è³£)', location: 'å‘¼å­æœå¸‚' },
                    { type: 'meal', time: '10:15-11:30', activity: 'ğŸ± åˆé¤ï¼šæ´»çƒè³Šå®šé£Ÿ (å»ºè­°æ²³å¤ªéƒæˆ–å‘¼å­æµ·èˆŸ)', location: 'æ²³å¤ªéƒ å‘¼å­åº—' },
                    { type: 'attraction', time: '12:00-13:00', activity: 'ğŸ° å”æ´¥åŸ (åŸä¸‹ç”ºæ•£æ­¥ã€å¤©å®ˆé–£å±•æœ›)', location: 'å”æ´¥åŸ' },
                    { type: 'attraction', time: '13:30-14:30', activity: 'ğŸ“¸ é¡å±±å±•æœ›å° (ä¸ƒå½©æµ·æ™¯ã€è™¹ä¹‹æ¾åŸæ™¯è§€)', location: 'é¡å±±å±•æœ›å°' },
                    { type: 'transport', time: '15:00', activity: 'ğŸµ é€”ä¸­ä¼‘æ¯' },
                    { type: 'meal', time: '18:30', activity: 'ğŸ½ æ™šé¤ (å»ºè­°å›åˆ°ä½è³€å¸‚å€åƒæ™šé¤)' },
                    { type: 'hotel', time: '20:00', activity: 'å›é£¯åº—ä¼‘æ¯' },
                ]
            },
            {
                day: 3, date: '12/16ï¼ˆäºŒï¼‰', city: 'æ­¦é›„å¸‚', theme: 'è‡ªé§•ãƒ»ç¥å¾·ç¨»è·ç¥ç¤¾ â†’ æ­¦é›„å¸‚åœ–æ›¸é¤¨ â†’ æ­¦é›„æº«æ³‰æ¨“é–€',
                details: [
                    { type: 'transport', time: '09:00', activity: 'ğŸš— é£¯åº—å‡ºç™¼ â†’ ç¥å¾·ç¨»è·ç¥ç¤¾ (è»Šç¨‹ç´„ 60 åˆ†, å°èˆªï¼šç¥å¾·ç¨»è·ç¥ç¤¾)', location: 'ç¥å¾³ç¨²è·ç¥ç¤¾' },
                    { type: 'attraction', time: '10:00-11:30', activity: 'â›©ï¸ ç¥å¾·ç¨»è·ç¥ç¤¾ (è¯éº—çš„ã€Œè¥¿æ—¥æœ¬æ—¥å…‰ã€)', location: 'ç¥å¾³ç¨²è·ç¥ç¤¾' },
                    { type: 'meal', time: '12:00-13:00', activity: 'ğŸœ åˆé¤ (ç¥å¾·ç¨»è·æˆ–æ­¦é›„å¸‚å‘¨é‚Š)' },
                    { type: 'attraction', time: '13:30-14:30', activity: 'ğŸ“š æ­¦é›„å¸‚åœ–æ›¸é¤¨ (çŸ¥åæ–‡å‰µåœ°æ¨™)', location: 'æ­¦é›„å¸‚å›³æ›¸é¤¨' },
                    { type: 'attraction', time: '14:45-15:45', activity: 'â™¨ï¸ æ­¦é›„æº«æ³‰æ¨“é–€ (æœ±ç´…è‰²çš„æ­·å²æ¨“é–€)', location: 'æ­¦é›„æ¸©æ³‰æ¥¼é–€' },
                    { type: 'shopping', time: '17:00', activity: 'ğŸ› æ°¸æ—ºå¤¢æ¨‚åŸ (Aeon Mall) æˆ–å…¶ä»–é †è·¯çš„è³¼ç‰©é»', location: 'æ°¸æ—ºå¤¢æ¨‚åŸä½è³€' },
                    { type: 'meal', time: '19:00', activity: 'ğŸ½ æ™šé¤ (å¸‚å€æˆ– Aeon Mall è§£æ±º)' },
                    { type: 'hotel', time: '20:30', activity: 'å›é£¯åº—ä¼‘æ¯' },
                ]
            },
            {
                day: 4, date: '12/17ï¼ˆä¸‰ï¼‰', city: 'ä½è³€å¸‚', theme: 'ä½è³€å¸‚å€ãƒ»ä½è³€åŸ â†’ Youme Town',
                details: [
                    { type: 'attraction', time: '10:00-12:00', activity: 'ğŸ¯ ä½è³€åŸæœ¬ä¸¸æ­·å²é¤¨ (æ—¥æœ¬æœ€å¤§è¦æ¨¡çš„æœ¨é€ å»ºç¯‰å¾©åŸ)', location: 'ä½è³€åŸæœ¬ä¸¸æ­´å²é¤¨' },
                    { type: 'meal', time: '12:30-13:30', activity: 'ğŸœ åˆé¤ (ä½è³€åŸé™„è¿‘æˆ– Youme Town è§£æ±º)', location: 'Youme Town Saga' },
                    { type: 'shopping', time: '14:00-17:00', activity: 'ğŸ›’ Youme Town Saga (å¤§å‹è³¼ç‰©ä¸­å¿ƒï¼Œè³¼è²·ä¼´æ‰‹ç¦®èˆ‡é›œè²¨)', location: 'Youme Town Saga' },
                    { type: 'meal', time: '18:30', activity: 'ğŸ½ æ™šé¤ (å¸‚å€ç‰¹è‰²é¤å»³)' },
                    { type: 'hotel', time: '20:00', activity: 'å›é£¯åº—ï¼Œæ•´ç†è¡Œæ' },
                ]
            },
            {
                day: 5, date: '12/18ï¼ˆå››ï¼‰', city: 'ä½è³€å¸‚', theme: 'è¿”ç¨‹ â†’ ä½è³€æ©Ÿå ´',
                details: [
                    { type: 'hotel', time: '10:00', activity: 'ğŸ¨ è¾¦ç†é€€æˆ¿æ‰‹çºŒ (æ±æ©«INN)' },
                    { type: 'meal', time: '10:30-11:30', activity: 'åˆé¤æˆ–åœ¨è»Šç«™å‘¨é‚Šæ¡è³¼æœ€å¾Œçš„ç´€å¿µå“' },
                    { type: 'transport', time: '12:00', activity: 'ğŸš æ­ä¹˜ä½è³€æ©Ÿå ´å·´å£« â†’ ä½è³€æ©Ÿå ´' },
                    { type: 'flight', time: '14:00', activity: 'âœˆï¸ æ«ƒæª¯å ±åˆ° (IT247 ä½è³€ â†’ æ¡ƒåœ’)' },
                    { type: 'flight', time: '15:25', activity: 'èµ·é£›ï¼ŒçµæŸæ„‰å¿«çš„ä½è³€æ—…ç¨‹' },
                ]
            },
        ];

        // å°èˆªåœ–æ¨™å°æ‡‰è¡¨
        const typeIcons = {
            'attraction': 'ğŸ°',
            'meal': 'ğŸ½ï¸',
            'transport': 'ğŸš—',
            'shopping': 'ğŸ›ï¸',
            'flight': 'âœˆï¸',
            'hotel': 'ğŸ¨',
            'default': 'ğŸ“'
        };

        // --- è¼”åŠ©å‡½å¼ (å½ˆå‡ºè¦–çª—å–ä»£ alert/confirm) ---

        // è‡ªå®šç¾© Alert
        window.customAlert = (title, message) => {
            return new Promise(resolve => {
                const modalContainer = document.getElementById('modal-container');
                const modal = document.createElement('div');
                modal.className = 'custom-modal';
                modal.innerHTML = `
                    <div class="modal-content w-96">
                        <h3 class="text-xl font-bold mb-3 text-primary">${title}</h3>
                        <p class="mb-4 text-gray-700">${message}</p>
                        <div class="flex justify-end">
                            <button id="modal-close" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-emerald-600 font-medium">ç¢ºèª</button>
                        </div>
                    </div>
                `;
                modalContainer.appendChild(modal);

                document.getElementById('modal-close').onclick = () => {
                    modalContainer.removeChild(modal);
                    resolve();
                };
            });
        };

        // è‡ªå®šç¾© Confirm
        window.customConfirm = (title, message) => {
            return new Promise(resolve => {
                const modalContainer = document.getElementById('modal-container');
                const modal = document.createElement('div');
                modal.className = 'custom-modal';
                modal.innerHTML = `
                    <div class="modal-content w-96">
                        <h3 class="text-xl font-bold mb-3 text-red-600">${title}</h3>
                        <p class="mb-4 text-gray-700">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100 font-medium">å–æ¶ˆ</button>
                            <button id="modal-ok" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium">ç¢ºå®š</button>
                        </div>
                    </div>
                `;
                modalContainer.appendChild(modal);

                document.getElementById('modal-ok').onclick = () => {
                    modalContainer.removeChild(modal);
                    resolve(true);
                };
                document.getElementById('modal-cancel').onclick = () => {
                    modalContainer.removeChild(modal);
                    resolve(false);
                };
            });
        };


        // --- Gemini API å‡½å¼ (é™„å¸¶æŒ‡æ•¸é€€é¿) ---
        async function fetchGeminiContent(systemPrompt, userQuery, maxRetries = 5) {
            const apiKey = ""; // ç•™ç©ºï¼ŒCanvas æœƒè‡ªå‹•æä¾›
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // å•Ÿç”¨ Google Search Grounding
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            document.getElementById('loading-indicator').classList.remove('hidden');

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue;
                        }
                        throw new Error(`API response status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        return text;
                    }
                    throw new Error("Invalid response structure from Gemini API.");

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) {
                        throw new Error("Gemini API å‘¼å«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    }
                } finally {
                     document.getElementById('loading-indicator').classList.add('hidden');
                }
            }
        }
        
        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šAI å°éŠåˆ†æ ---
        async function fetchGuideContent(day, city, theme) {
            const container = document.getElementById(`guide-analysis-day-${day}`);
            const button = document.getElementById(`btn-guide-day-${day}`);
            
            button.disabled = true;
            button.textContent = 'åˆ†æä¸­... è«‹ç­‰å¾…';
            container.innerHTML = '<p class="p-4 text-center text-gray-500">AI å°éŠæ­£åœ¨ç‚ºæ‚¨æœå°‹æœ€æ–°æ”»ç•¥èˆ‡å¿…å‚™è³‡è¨Š...</p>';

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä½è³€æ—…éŠå°éŠï¼Œè«‹æ ¹æ“šç”¨æˆ¶æä¾›çš„æ¯æ—¥è¡Œç¨‹ï¼Œåˆ©ç”¨ Google æœå°‹æœ€æ–°çš„è³‡è¨Šï¼Œä¸¦æä¾›ä¸€å€‹ç´„ 200 å­—çš„ç²¾ç°¡æ”»ç•¥ã€‚å…§å®¹å¿…é ˆåŒ…å«ä»¥ä¸‹å¹¾é»ï¼š1. è©²åŸå¸‚æˆ–æ™¯é»çš„å³æ™‚å¤©æ°£æ¦‚æ³ï¼ˆæº«åº¦ã€é™é›¨æ©Ÿç‡ã€å¤©æ°£é¡å‹ï¼‰ã€‚2. å»ºè­°çš„å¿…åƒç¾é£Ÿæˆ–ç‰¹è‰²èœé¤šã€‚3. å»ºè­°çš„å¿…è²·ä¼´æ‰‹ç¦®ã€‚4. ä»»ä½•é‡è¦çš„æ—…éŠæç¤ºï¼ˆä¾‹å¦‚ï¼šåœè»Šã€é ç´„ï¼‰ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¸¦å°‡é—œéµè³‡è¨Šç”¨ HTML æ¨™ç±¤æ¨™è¨˜ï¼š<span class='tag-must-eat'>å¿…åƒ/å¿…é»</span>ã€<span class='tag-must-buy'>å¿…è²·ä¼´æ‰‹ç¦®</span>ã€<span class='tag-important'>é‡è¦æç¤º/ä»£è™Ÿ</span>ã€‚";
            
            const userQuery = `è«‹åˆ†æä½è³€æ—…è¡Œç¬¬ ${day} å¤©çš„è¡Œç¨‹ï¼šåŸå¸‚ï¼š${city}ï¼Œä¸»é¡Œï¼š${theme}ã€‚è«‹æä¾›æ”»ç•¥ã€‚`;

            try {
                const rawText = await fetchGeminiContent(systemPrompt, userQuery);
                container.innerHTML = `<div class="p-4 bg-yellow-50 rounded-lg text-sm text-gray-800 space-y-2">${rawText}</div>`;
            } catch (error) {
                container.innerHTML = `<p class="p-4 text-center text-red-500">âŒ AI å°éŠåˆ†æå¤±æ•—: ${error.message}</p>`;
                console.error('AI Guide Error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'AI å°éŠåˆ†æèˆ‡æ”»ç•¥';
            }
        }
        
        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå¤©æ°£æŸ¥è©¢ ---
        async function fetchWeather(city, day) {
            const container = document.getElementById(`weather-day-${day}`);
            const weatherBtn = document.getElementById(`btn-weather-day-${day}`);
            weatherBtn.disabled = true;
            
            container.innerHTML = 'æ­£åœ¨æŸ¥è©¢å¤©æ°£...';
            
            const systemPrompt = "ä½ æ˜¯ä¸€ä½ç²¾æº–çš„å³æ™‚å¤©æ°£å ±å°å“¡ï¼Œè«‹æ ¹æ“šç”¨æˆ¶æä¾›çš„åœ°é»ï¼Œä½¿ç”¨ Google Search æŸ¥è©¢ç•¶åœ°çš„å³æ™‚æˆ–æœ€æ–°çš„å¤©æ°£ç‹€æ³ï¼ˆæº«åº¦ã€é™é›¨æ©Ÿç‡ã€å¤©æ°£é¡å‹ï¼‰ã€‚è«‹ç”¨ä¸€å¥è©±ç°¡çŸ­ç¸½çµä¸¦åŒ…å«å»ºè­°ç©¿æ­ï¼Œä¸¦ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚";
            const userQuery = `ä½è³€ç¸£ ${city} çš„æœ€æ–°å¤©æ°£æ¦‚æ³ã€‚`;

            try {
                const weatherText = await fetchGeminiContent(systemPrompt, userQuery);
                container.innerHTML = `<span class="font-semibold text-primary">â˜ï¸ å¤©æ°£é å ±:</span> ${weatherText}`;
            } catch (error) {
                 container.innerHTML = `<span class="font-semibold text-primary">â˜ï¸ å¤©æ°£é å ±:</span> ç„¡æ³•ç²å–å³æ™‚å¤©æ°£ã€‚`;
            } finally {
                weatherBtn.disabled = false;
            }
        }

        // --- Tab åˆ‡æ›åŠŸèƒ½ ---
        function switchTab(tabId) {
            const tabs = ['itinerary', 'tools'];
            tabs.forEach(id => {
                document.getElementById(`${id}-content`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.remove('active');
            });

            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        // --- è¡Œç¨‹æ¸²æŸ“åŠŸèƒ½ ---
        function renderItinerary() {
            const listContainer = document.getElementById('itinerary-list');
            
            initialLoadingMessage.classList.add('hidden');
            listContainer.innerHTML = '';
            
            ITINERARY_DATA.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'bg-white p-5 rounded-xl card-shadow';
                dayCard.innerHTML = `
                    <h2 class="text-2xl font-extrabold text-gray-800 border-b-2 border-primary pb-2 mb-4">
                        Day ${day.day}: ${day.date}
                    </h2>
                    <h3 class="text-lg font-semibold text-secondary mb-3">${day.theme} (${day.city})</h3>

                    <!-- å¤©æ°£é å ±å€å¡Š -->
                    <div id="weather-day-${day.day}" class="p-3 mb-4 bg-primary bg-opacity-10 rounded-lg text-sm text-gray-800">
                        <span class="font-semibold text-primary">â˜ï¸ å¤©æ°£é å ±:</span> é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥è©¢ã€‚
                    </div>

                    <!-- è¡Œç¨‹ç´°ç¯€ -->
                    <ul class="space-y-4 mb-4">
                        ${day.details.map(detail => {
                            const icon = typeIcons[detail.type] || typeIcons['default'];
                            const locationBtn = detail.location ? 
                                `<button onclick="window.open('https://maps.google.com/?q=${encodeURIComponent(detail.location)}', '_blank')" class="ml-2 px-3 py-1 text-xs bg-secondary text-white rounded-full hover:bg-blue-600 transition">
                                    å°èˆª
                                </button>` : '';

                            return `
                                <li class="flex items-start text-gray-700 p-2 bg-gray-50 rounded-lg border-l-4 border-${detail.type === 'meal' ? 'pink-400' : detail.type === 'attraction' ? 'teal-400' : 'gray-300'}">
                                    <span class="text-base font-bold text-gray-600 min-w-[5rem] flex-shrink-0">${detail.time}</span>
                                    <span class="ml-4 flex-grow text-base">${icon} ${detail.activity} ${locationBtn}</span>
                                </li>
                            `;
                        }).join('')}
                    </ul>

                    <!-- AI å°éŠèˆ‡æ“ä½œæŒ‰éˆ• -->
                    <div class="flex flex-col space-y-2 mt-4">
                        <button id="btn-guide-day-${day.day}" onclick="fetchGuideContent(${day.day}, '${day.city}', '${day.theme}')" class="w-full px-4 py-2 bg-highlight text-white rounded-lg hover:bg-amber-600 transition duration-150 font-semibold shadow-md">
                            AI å°éŠåˆ†æèˆ‡æ”»ç•¥
                        </button>
                        <button id="btn-weather-day-${day.day}" onclick="fetchWeather('${day.city}', ${day.day})" class="w-full px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition duration-150 font-semibold">
                            æŸ¥è©¢ç•¶æ—¥å¤©æ°£
                        </button>
                    </div>

                    <!-- AI æ”»ç•¥å…§å®¹å€å¡Š -->
                    <div id="guide-analysis-day-${day.day}" class="mt-4 border-t pt-4">
                        <p class="text-sm text-gray-500">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç²å–å¿…åƒã€å¿…è²·èˆ‡æ™¯é»æ”»ç•¥ã€‚</p>
                    </div>
                `;
                listContainer.appendChild(dayCard);
            });
        }
        
        // --- è¨˜å¸³åŠŸèƒ½ (Firebase/LocalStorage çµ±ä¸€è™•ç†) ---
        
        // LocalStorage è³‡æ–™åŒæ­¥è¼”åŠ©å‡½æ•¸
        function syncLocalStorage() {
            try {
                // æ’åºä¸¦å„²å­˜ (æœ€æ–°çš„åœ¨å‰é¢)
                expenses.sort((a, b) => b.timestamp - a.timestamp);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(expenses));
            } catch (error) {
                console.error("ç„¡æ³•å¯«å…¥ LocalStorage:", error);
                customAlert('å„²å­˜éŒ¯èª¤', 'ç€è¦½å™¨ç©ºé–“ä¸è¶³ï¼Œç„¡æ³•ä¿å­˜è¨˜å¸³è¨˜éŒ„ã€‚');
            }
            renderExpensesList();
        }

        async function setupFirestoreListener() {
            const listContainer = document.getElementById('expense-list');
            const loadingElement = document.getElementById('expense-loading');

            // å•Ÿç”¨è¼¸å…¥æ¡†
            document.getElementById('expense-desc').disabled = false;
            document.getElementById('expense-amount').disabled = false;
            document.querySelector('#tools-content button.bg-primary').disabled = false;
            document.querySelector('#tools-content button.bg-primary').classList.remove('opacity-50');


            if (useLocalStorage) {
                // *** LocalStorage æ¨¡å¼ ***
                listContainer.innerHTML = '<p class="text-center text-highlight font-bold py-2 bg-yellow-100 rounded-lg">âš ï¸ ä½¿ç”¨ç€è¦½å™¨æœ¬åœ°å„²å­˜ï¼Œè¨˜éŒ„ä¸æœƒåŒæ­¥æˆ–åˆ†äº«ã€‚</p>';
                
                try {
                    const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    expenses = savedData ? JSON.parse(savedData) : [];
                    // å°‡ timestamp å¾æ•¸å­—è½‰å›æ—¥æœŸç‰©ä»¶çš„æ¯«ç§’æ•¸ (ç”¨æ–¼æ’åº)
                    expenses.forEach(e => { e.timestamp = e.timestamp || Date.now(); });
                    syncLocalStorage(); 
                } catch (error) {
                    console.error("Error loading from LocalStorage:", error);
                    listContainer.innerHTML = '<p class="text-center text-red-600 font-bold py-4 bg-red-100 rounded-lg">âŒ è®€å–æœ¬åœ°å„²å­˜å¤±æ•—ã€‚</p>';
                }
                loadingElement.classList.add('hidden');
                return;
            }
            
            // *** Firebase æ¨¡å¼ ***
            // ç§äººè³‡æ–™é›†åˆè·¯å¾‘
            const expensesCollectionPath = `artifacts/${appId}/users/${window.userId}/expenses`;
            
            // ä½¿ç”¨ onSnapshot å³æ™‚ç›£è½è³‡æ–™
            onSnapshot(collection(window.db, expensesCollectionPath), (snapshot) => {
                expenses = [];
                snapshot.forEach(doc => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                // ä¾æ“šæ™‚é–“æˆ³è¨˜å¾æ–°åˆ°èˆŠæ’åº (Firestore timestamp éœ€è½‰æ›)
                expenses.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); 
                renderExpensesList();
            }, (error) => {
                console.error("Error listening to expenses:", error);
                listContainer.innerHTML = '<p class="text-center text-red-500 py-4">è³‡æ–™åº«é€£ç·šå¤±æ•—ã€‚</p>';
            });
            
            loadingElement.classList.add('hidden');
        }
        
        function renderExpensesList() {
            const listContainer = document.getElementById('expense-list');
            const totalDisplay = document.getElementById('total-expense');
            
            listContainer.querySelectorAll('.expense-item').forEach(e => e.remove()); // æ¸…é™¤èˆŠåˆ—è¡¨
            
            let total = 0;
            if (expenses.length === 0) {
                 const warning = document.createElement('p');
                 warning.className = 'text-gray-500 text-center py-4';
                 warning.textContent = 'ç›®å‰æ²’æœ‰ä»»ä½•æ”¯å‡ºè¨˜éŒ„ã€‚';
                 listContainer.appendChild(warning);
            }

            expenses.forEach((item) => {
                total += item.amount;
                // è™•ç† LocalStorage (æ•¸å­—) å’Œ Firestore (Timestamp ç‰©ä»¶) çš„æ™‚é–“
                const dateMs = useLocalStorage ? item.timestamp : (item.timestamp?.toMillis() || Date.now());
                const date = new Date(dateMs);
                const formattedTime = date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }) + ' ' +
                                      date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit', hour12: false});

                const expenseItem = document.createElement('div');
                expenseItem.id = `item-${item.id}`;
                expenseItem.className = 'expense-item flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-150 border-b';
                expenseItem.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-medium text-gray-800">${item.desc}</p>
                        <p class="text-xs text-gray-500">${formattedTime}</p>
                    </div>
                    <div class="flex items-center">
                        <span class="text-lg font-bold text-red-500 mr-3 tabular-nums">Â¥ ${item.amount.toLocaleString()}</span>
                        <button onclick="deleteExpense('${item.id}')" class="text-red-400 hover:text-red-600 transition duration-150 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                listContainer.appendChild(expenseItem);
            });

            totalDisplay.textContent = `Â¥ ${total.toLocaleString()}`;
        }

        async function addExpense() {
            const descInput = document.getElementById('expense-desc');
            const amountInput = document.getElementById('expense-amount');
            const desc = descInput.value.trim();
            const amount = parseInt(amountInput.value, 10);
            
            if (!desc || isNaN(amount) || amount <= 0) {
                 await customAlert('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„è²»ç”¨èªªæ˜å’Œé‡‘é¡ã€‚');
                 return;
            }
            
            descInput.value = '';
            amountInput.value = '';

            if (useLocalStorage) {
                // *** LocalStorage æ¨¡å¼ ***
                const newId = crypto.randomUUID();
                expenses.unshift({ // unshift: åŠ åˆ°æœ€å‰é¢
                    id: newId,
                    desc,
                    amount,
                    timestamp: Date.now() // ä½¿ç”¨ JS æ™‚é–“æˆ³è¨˜
                });
                syncLocalStorage();
                return;
            }

            // *** Firebase æ¨¡å¼ ***
            try {
                const expensesCollectionPath = `artifacts/${appId}/users/${window.userId}/expenses`;
                await addDoc(collection(window.db, expensesCollectionPath), {
                    desc,
                    amount,
                    timestamp: serverTimestamp() 
                });
            } catch (e) {
                console.error("Error adding document: ", e);
                await customAlert('è³‡æ–™åº«éŒ¯èª¤', 'ç„¡æ³•æ–°å¢æ”¯å‡ºï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚');
            }
        }

        async function deleteExpense(id) {
            const confirmed = await customConfirm('ç¢ºèªåˆªé™¤', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ');
            if (!confirmed) return;
            
            if (useLocalStorage) {
                // *** LocalStorage æ¨¡å¼ ***
                const initialLength = expenses.length;
                expenses = expenses.filter(e => e.id !== id);
                if (expenses.length < initialLength) {
                    syncLocalStorage();
                } else {
                    await customAlert('åˆªé™¤å¤±æ•—', 'æ‰¾ä¸åˆ°å°æ‡‰è¨˜éŒ„ã€‚');
                }
                return;
            }

            // *** Firebase æ¨¡å¼ ***
            try {
                const docPath = `artifacts/${appId}/users/${window.userId}/expenses/${id}`;
                await deleteDoc(doc(window.db, docPath));
            } catch (e) {
                console.error("Error deleting document: ", e);
                await customAlert('è³‡æ–™åº«éŒ¯èª¤', 'ç„¡æ³•åˆªé™¤æ”¯å‡ºï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚');
            }
        }
        
        // --- æ‡‰ç”¨ç¨‹å¼çµ±ä¸€å•Ÿå‹•å‡½æ•¸ ---
        function startApp() {
             // éš±è—åˆå§‹çš„è¼‰å…¥æç¤º
            initialLoadingMessage.classList.add('hidden');
            
            renderItinerary();
            setupFirestoreListener();
        }

        // å°‡æ ¸å¿ƒåŠŸèƒ½æš´éœ²çµ¦å…¨åŸŸç’°å¢ƒ
        window.switchTab = switchTab;
        window.fetchGuideContent = fetchGuideContent;
        window.fetchWeather = fetchWeather;
        window.addExpense = addExpense;
        window.deleteExpense = deleteExpense;
        
    </script>
</body>
</html>